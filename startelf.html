<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Startelf – GoalNewsDE</title>
<style>
body { font-family: "Poppins", sans-serif; background: radial-gradient(circle at center, #0a1a2f, #060c18); color: white; margin: 0; padding: 0; text-align: center; }
h1 { margin-top: 20px; font-size: 28px; letter-spacing: 1px; }
.field { width: 90%; max-width: 600px; aspect-ratio: 2/3; background: linear-gradient(to bottom, #0b3d0b, #063f06); border: 3px solid #ffffff33; border-radius: 20px; margin: 30px auto; position: relative; overflow: hidden; }
.circle { width: 60px; height: 60px; background: #004cff; border: 3px solid white; border-radius: 50%; position: absolute; display: flex; justify-content: center; align-items: center; flex-direction: column; color: white; font-size: 12px; cursor: pointer; transition: transform 0.2s; }
.circle:hover { transform: scale(1.1); }
.player-number { font-weight: bold; font-size: 16px; }
.team-label { font-size: 20px; margin: 10px 0; }
.admin-panel { margin: 20px auto; background: #0a1730; padding: 15px; border-radius: 10px; max-width: 600px; text-align: left; }
.admin-panel select, .admin-panel button { padding: 6px; margin: 5px 0; border-radius: 5px; border: none; outline: none; }
.admin-panel button { background: #0066ff; color: white; cursor: pointer; }
</style>
</head>
<body>

<h1>Startelf – GoalNewsDE</h1>

<div id="adminPanel" class="admin-panel" style="display:none;">
  <h3>⚙️ Admin-Einstellungen</h3>
  <label>Team:</label>
  <select id="teamSelect">
    <option value="home">Heim</option>
    <option value="away">Auswärts</option>
  </select><br>
  <label>Formation:</label>
  <select id="formationSelect">
    <option value="4-4-2">4-4-2</option>
    <option value="4-3-3">4-3-3</option>
    <option value="3-5-2">3-5-2</option>
    <option value="4-2-3-1">4-2-3-1</option>
    <option value="4-4-1-1">4-4-1-1</option>
    <option value="5-3-2">5-3-2</option>
  </select><br>
  <button id="updateFormation">Formation speichern</button>
</div>

<div class="team-label">Heim-Team</div>
<div id="homeField" class="field"></div>

<div class="team-label">Auswärts-Team</div>
<div id="awayField" class="field"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBmIcdFtxv4jBJKdiAkEiwnkQ8yRwiG_0w",
  authDomain: "goalnewsde-community.firebaseapp.com",
  projectId: "goalnewsde-community",
  storageBucket: "goalnewsde-community.firebasestorage.app",
  messagingSenderId: "134523022055",
  appId: "1:134523022055:web:4f35ed7812d06e4fb55042"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const ADMIN_UIDS = ["g7Lsh9MshAOkwbyHcO3NFsnUpZl1","lwRnonWRhMOeYedZLAldySkEKso2"];
let isAdmin = false;

const formations = {
  "4-4-2": [[1],[2,3,4,5],[6,7,8,9],[10,11]],
  "4-3-3": [[1],[2,3,4,5],[6,7,8],[9,10,11]],
  "3-5-2": [[1],[2,3,4],[5,6,7,8,9],[10,11]],
  "4-2-3-1": [[1],[2,3,4,5],[6,7],[8,9,10],[11]],
  "4-4-1-1": [[1],[2,3,4,5],[6,7,8,9],[10],[11]],
  "5-3-2": [[1],[2,3,4,5,6],[7,8,9],[10,11]]
};

let teams = {};

// Sicherstellen, dass Team existiert
async function ensureTeamExists(teamName){
  const ref = doc(db,"startelf",teamName);
  const snap = await getDoc(ref);
  if(!snap.exists()){
    await setDoc(ref,{formation:"4-4-2", players:[]});
  }
  return ref;
}

// Team laden & live Updates
async function loadTeam(teamName){
  const teamRef = await ensureTeamExists(teamName);

  onSnapshot(teamRef,(docSnap)=>{
    const data = docSnap.data();
    if(!data.players) data.players=[];
    teams[teamName] = data;
    renderTeam(teamName);
  });
}

// Team rendern
function renderTeam(teamName){
  const field = document.getElementById(teamName+"Field");
  field.innerHTML="";
  const team = teams[teamName];
  const form = formations[team.formation] || formations["4-4-2"];
  const rect = field.getBoundingClientRect();
  const width = rect.width;
  const height = rect.height;
  const yGap = height/(form.length+1);
  let playerIndex = 0;

  for(let i=0;i<form.length;i++){
    const line = form[i];
    const xGap = width/(line.length+1);
    for(let j=0;j<line.length;j++){
      const p = team.players[playerIndex];
      const x = xGap*(j+1);
      const y = yGap*(i+1);
      const div = document.createElement("div");
      div.className="circle";
      div.style.left=`${x-30}px`;
      div.style.top=`${y-30}px`;
      div.innerHTML = p && p.name!="?" ? `<div class="player-number">${p.number}</div><div>${p.name}</div>` : "+";

      if(isAdmin){
        div.onclick = async()=>{
          const name = prompt("Spielername eingeben:",p?p.name:"");
          if(name===null) return;
          const number = prompt("Nummer eingeben:",p?p.number:"");
          if(number===null) return;

          const playersCopy = [...team.players];
          while(playersCopy.length <= playerIndex){
              playersCopy.push({name:"?", number:"?"});
          }
          playersCopy[playerIndex] = {name, number};

          await setDoc(doc(db,"startelf",teamName), {formation: team.formation, players: playersCopy}, {merge:true});
        }
      }

      field.appendChild(div);
      playerIndex++;
    }
  }
}

// Formation speichern
document.getElementById("updateFormation").onclick = async()=>{
  const teamName = document.getElementById("teamSelect").value;
  const formation = document.getElementById("formationSelect").value;
  const team = teams[teamName];
  await setDoc(doc(db,"startelf",teamName), {formation, players: team.players}, {merge:true});
}

// Auth & Ladefunktion
onAuthStateChanged(auth,user=>{
  if(user && ADMIN_UIDS.includes(user.uid)){
    isAdmin=true;
    document.getElementById("adminPanel").style.display="block";
  }
  loadTeam("home");
  loadTeam("away");
});
</script>
</body>
</html>
