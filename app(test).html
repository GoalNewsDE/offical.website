from flask import Flask, request, g, render_template, redirect
import sqlite3, hmac, hashlib, os, requests, json
from datetime import datetime

app = Flask(__name__)

DB_PATH = "monitor.db"
IP_SALT = os.environ.get("IP_SALT", "change_this_secret")

# DB init
def get_db():
db = getattr(g, "_database", None)
if db is None:
db = g._database = sqlite3.connect(DB_PATH)
db.row_factory = sqlite3.Row
db.execute("""
CREATE TABLE IF NOT EXISTS hits (
id INTEGER PRIMARY KEY,
ts TEXT,
hashed_ip TEXT,
country TEXT,
region TEXT,
ua TEXT
)
""")
db.commit()
return db

@app.teardown_appcontext
def close_db(e=None):
db = getattr(g, "_database", None)
if db: db.close()

# Hilfsfunktionen
def hash_ip(ip):
return hmac.new(IP_SALT.encode(), ip.encode(), hashlib.sha256).hexdigest()

def lookup_geo(ip):
try:
r = requests.get(f"http://ip-api.com/json/{ip}?fields=status,country,regionName", timeout=3)
j = r.json()
if j.get("status") == "success":
return j.get("country","unknown"), j.get("regionName","unknown")
except:
pass
return "unknown","unknown"

def get_client_ip():
forwarded = request.headers.get("X-Forwarded-For")
if forwarded:
return forwarded.split(",")[0]
return request.remote_addr or "0.0.0.0"

# Route für index.html (überwacht)
@app.route("/")
def index():
consent = request.cookies.get("cookies-accepted")
if consent=="true":
ip = get_client_ip()
hashed = hash_ip(ip)
country, region = lookup_geo(ip)
ua = request.headers.get("User-Agent","")[:1024]
db = get_db()
db.execute("INSERT INTO hits (ts, hashed_ip, country, region, ua) VALUES (?,?,?, ?,?)",
(datetime.utcnow().isoformat(), hashed, country, region, ua))
db.commit()
# index.html aus static ausliefern
return app.send_static_file("index.html")

# Dashboard (Basic Auth einfach)
@app.route("/dashboard")
def dashboard():
db = get_db()
rows = db.execute("SELECT * FROM hits ORDER BY ts DESC LIMIT 100").fetchall()
return render_template("dashboard.html", rows=rows)

if __name__=="__main__":
app.run(debug=True)