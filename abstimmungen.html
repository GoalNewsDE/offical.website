<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GoalNewsDE Abstimmungen</title>
<style>
body { font-family: 'Poppins', sans-serif; background:#121212; color:white; padding:20px; }
h2,h3 { color:#1db954; }
button { background:#1db954; color:white; border:none; padding:10px 16px; border-radius:8px; cursor:pointer; margin:5px 0; }
button:hover { background:#17a44b; }
#pollForm { display:none; margin-top:20px; background:rgba(255,255,255,0.05); padding:20px; border-radius:12px; }
#results { margin-top:20px; }
.result-bar { height:28px; background:#1db954; border-radius:12px; margin-bottom:5px; text-align:right; padding-right:10px; line-height:28px; color:white; transition: width 0.3s; }
.admin-section { margin-top:30px; padding:20px; background:rgba(255,255,255,0.1); border-radius:12px; }
input, select { padding:8px; border-radius:6px; border:none; margin-right:5px; }
.poll-container { margin-bottom:40px; border:1px solid rgba(255,255,255,0.1); padding:15px; border-radius:12px; }
</style>
</head>
<body>

<h2>üìä GoalNewsDE Abstimmungen</h2>

<div id="pollsContainer"></div>

<!-- Admin Bereich -->
<div id="adminSection" class="admin-section" style="display:none;">
<h3>‚öôÔ∏è Admin-Panel</h3>
<input type="text" id="newPollTitle" placeholder="Titel der Abstimmung">
<input type="text" id="newOption" placeholder="Option hinzuf√ºgen">
<button id="addOptionBtn">‚ûï Option</button>
<button id="createPollBtn">üÜï Neue Abstimmung erstellen</button>
<div id="adminPolls"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
import { getFirestore, collection, doc, setDoc, updateDoc, deleteDoc, increment, onSnapshot, getDocs } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

// üîπ Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyBmIcdFtxv4jBJKdiAkEiwnkQ8yRwiG_0w",
  authDomain: "goalnewsde-community.firebaseapp.com",
  projectId: "goalnewsde-community",
  storageBucket: "goalnewsde-community.firebasestorage.app",
  messagingSenderId: "134523022055",
  appId: "1:134523022055:web:4f35ed7812d06e4fb55042"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// üîπ Admin UIDs
const adminUIDs = ["g7Lsh9MshAOkwbyHcO3NFsnUpZl1","lwRnonWRhMOeYedZLAldySkEKso2"];
let currentUserIsAdmin = false;

// üîπ Elemente
const pollsContainer = document.getElementById("pollsContainer");
const adminSection = document.getElementById("adminSection");
const newPollTitle = document.getElementById("newPollTitle");
const newOptionInput = document.getElementById("newOption");
const addOptionBtn = document.getElementById("addOptionBtn");
const createPollBtn = document.getElementById("createPollBtn");
const adminPollsDiv = document.getElementById("adminPolls");

// üîπ Hilfsfunktion: polls laden
async function loadPolls() {
  pollsContainer.innerHTML = "";
  const pollsSnap = await getDocs(collection(db,"polls"));
  pollsSnap.forEach(async pollDoc => {
    const pollData = pollDoc.data();
    const pollId = pollDoc.id;

    const pollDiv = document.createElement("div");
    pollDiv.className = "poll-container";
    pollDiv.innerHTML = `<h3>${pollData.title}</h3>`;
    
    // Optionen Buttons
    const optionsContainer = document.createElement("div");
    for(const option of Object.keys(pollData.options)){
      const btn = document.createElement("button");
      btn.textContent = option;
      btn.addEventListener("click", async ()=>{
        const votedKey = `voted_${pollId}`;
        const prevVote = localStorage.getItem(votedKey);
        // Stimme √§ndern: vorherige Option abziehen
        if(prevVote){
          await updateDoc(doc(db,"polls",pollId), {[`options.${prevVote}`]: increment(-1)});
        }
        await updateDoc(doc(db,"polls",pollId), {[`options.${option}`]: increment(1)});
        localStorage.setItem(votedKey,option);
      });
      optionsContainer.appendChild(btn);
    }
    pollDiv.appendChild(optionsContainer);

    // Ergebnisse Balken
    const resultsDiv = document.createElement("div");
    resultsDiv.id = "results_" + pollId;
    pollDiv.appendChild(resultsDiv);

    pollsContainer.appendChild(pollDiv);

    // Live Updates
    onSnapshot(doc(db,"polls",pollId), docSnap=>{
      const data = docSnap.data();
      const resultsDiv = document.getElementById("results_" + pollId);
      resultsDiv.innerHTML = "";
      const totalVotes = Object.values(data.options).reduce((a,b)=>a+b,0);
      for(const [opt,votes] of Object.entries(data.options)){
        const percent = totalVotes>0?Math.round((votes/totalVotes)*100):0;
        const bar = document.createElement("div");
        bar.className = "result-bar";
        bar.style.width = percent + "%";
        bar.textContent = `${votes} (${percent}%)`;
        resultsDiv.appendChild(document.createElement("p")).textContent = opt;
        resultsDiv.appendChild(bar);
      }
    });
  });
}

// üîπ Admin Login Check
onAuthStateChanged(auth,user=>{
  if(user && adminUIDs.includes(user.uid)){
    currentUserIsAdmin = true;
    adminSection.style.display = "block";
  }
});

// üîπ Admin: Neue Abstimmung erstellen
createPollBtn.addEventListener("click", async ()=>{
  const title = newPollTitle.value.trim();
  if(!title) return alert("Bitte Titel eingeben!");
  const pollRef = doc(collection(db,"polls"));
  await setDoc(pollRef, { title, options:{} });
  newPollTitle.value="";
  loadPolls();
});

// üîπ Admin: Option hinzuf√ºgen
addOptionBtn.addEventListener("click", async ()=>{
  const option = newOptionInput.value.trim();
  if(!option) return alert("Bitte Option eingeben!");
  const pollsSnap = await getDocs(collection(db,"polls"));
  if(pollsSnap.empty) return alert("Erstelle zuerst eine Abstimmung!");
  const lastPoll = pollsSnap.docs[pollsSnap.docs.length-1];
  await updateDoc(doc(db,"polls",lastPoll.id), { [`options.${option}`]: 0 });
  newOptionInput.value="";
  loadPolls();
});

loadPolls();
</script>
</body>
</html>
